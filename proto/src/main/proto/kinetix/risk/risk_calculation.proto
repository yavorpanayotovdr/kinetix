syntax = "proto3";

package kinetix.risk;

option java_package = "com.kinetix.proto.risk";
option java_multiple_files = true;

import "kinetix/common/types.proto";
import "google/protobuf/timestamp.proto";

enum RiskCalculationType {
  RISK_CALCULATION_TYPE_UNSPECIFIED = 0;
  HISTORICAL = 1;
  PARAMETRIC = 2;
  MONTE_CARLO = 3;
}

enum ConfidenceLevel {
  CONFIDENCE_LEVEL_UNSPECIFIED = 0;
  CL_95 = 1;
  CL_99 = 2;
}

enum MarketDataType {
  MARKET_DATA_TYPE_UNSPECIFIED = 0;
  SPOT_PRICE = 1;
  HISTORICAL_PRICES = 2;
  VOLATILITY_SURFACE = 3;
  YIELD_CURVE = 4;
  RISK_FREE_RATE = 5;
  DIVIDEND_YIELD = 6;
  CREDIT_SPREAD = 7;
  FORWARD_CURVE = 8;
  CORRELATION_MATRIX = 9;
}

message TimeSeriesPoint {
  google.protobuf.Timestamp timestamp = 1;
  double value = 2;
}

message TimeSeries {
  repeated TimeSeriesPoint points = 1;
}

message Matrix {
  int32 rows = 1;
  int32 cols = 2;
  repeated double values = 3;   // row-major
  repeated string labels = 4;
}

message CurvePoint {
  string tenor = 1;
  double value = 2;
}

message Curve {
  repeated CurvePoint points = 1;
}

message MarketDataValue {
  MarketDataType data_type = 1;
  string instrument_id = 2;
  string asset_class = 3;
  oneof value {
    double scalar = 4;           // SPOT_PRICE, RISK_FREE_RATE, DIVIDEND_YIELD, CREDIT_SPREAD
    TimeSeries time_series = 5;  // HISTORICAL_PRICES
    Matrix matrix = 6;           // CORRELATION_MATRIX, VOLATILITY_SURFACE
    Curve curve = 7;             // YIELD_CURVE, FORWARD_CURVE
  }
}

message VaRRequest {
  kinetix.common.PortfolioId portfolio_id = 1;
  RiskCalculationType calculation_type = 2;
  ConfidenceLevel confidence_level = 3;
  int32 time_horizon_days = 4;
  int32 num_simulations = 5; // For Monte Carlo
  repeated kinetix.common.Position positions = 6;
  repeated MarketDataValue market_data = 7;
}

message VaRResponse {
  kinetix.common.PortfolioId portfolio_id = 1;
  RiskCalculationType calculation_type = 2;
  ConfidenceLevel confidence_level = 3;
  double var_value = 4;
  double expected_shortfall = 5;
  repeated VaRComponentBreakdown component_breakdown = 6;
  google.protobuf.Timestamp calculated_at = 7;
}

message VaRComponentBreakdown {
  kinetix.common.AssetClass asset_class = 1;
  double var_contribution = 2;
  double percentage_of_total = 3;
}

enum ValuationOutput {
  VALUATION_OUTPUT_UNSPECIFIED = 0;
  VAR = 1;
  EXPECTED_SHORTFALL = 2;
  GREEKS = 3;
}

message ValuationRequest {
  kinetix.common.PortfolioId portfolio_id = 1;
  RiskCalculationType calculation_type = 2;
  ConfidenceLevel confidence_level = 3;
  int32 time_horizon_days = 4;
  int32 num_simulations = 5;
  repeated kinetix.common.Position positions = 6;
  repeated MarketDataValue market_data = 7;
  repeated ValuationOutput requested_outputs = 8;
}

message GreeksSummary {
  repeated GreekValues asset_class_greeks = 1;
  double theta = 2;
  double rho = 3;
}

message GreekValues {
  kinetix.common.AssetClass asset_class = 1;
  double delta = 2;
  double gamma = 3;
  double vega = 4;
}

message ValuationResponse {
  kinetix.common.PortfolioId portfolio_id = 1;
  RiskCalculationType calculation_type = 2;
  ConfidenceLevel confidence_level = 3;
  double var_value = 4;
  double expected_shortfall = 5;
  repeated VaRComponentBreakdown component_breakdown = 6;
  google.protobuf.Timestamp calculated_at = 7;
  GreeksSummary greeks = 8;
  repeated ValuationOutput computed_outputs = 9;
}

service RiskCalculationService {
  // Deprecated: use Valuate instead
  rpc CalculateVaR(VaRRequest) returns (VaRResponse);
  rpc CalculateVaRStream(stream VaRRequest) returns (stream VaRResponse);
  rpc Valuate(ValuationRequest) returns (ValuationResponse);
}
