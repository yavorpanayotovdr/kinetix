groups:
  - name: kinetix-risk
    rules:
      - alert: VaRBreached
        expr: risk_var_value > 1000000
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "VaR breached threshold for portfolio {{ $labels.portfolio_id }}"
          description: "VaR value {{ $value }} exceeds 1,000,000 for portfolio {{ $labels.portfolio_id }}"

      - alert: RiskCalculationSlow
        expr: histogram_quantile(0.95, rate(var_calculation_duration_seconds_bucket[5m])) > 30
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: "Risk calculation p95 latency exceeds 30s"
          description: "P95 VaR calculation duration is {{ $value }}s"

  - name: kinetix-price
    rules:
      - alert: MarketDataStale
        expr: price_staleness_seconds > 60
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Market data is stale for {{ $labels.instrument_id }}"
          description: "Market data staleness is {{ $value }}s for {{ $labels.instrument_id }}"

  - name: kinetix-kafka
    rules:
      - alert: KafkaConsumerLag
        expr: kafka_consumer_group_lag > 10000
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "Kafka consumer lag is high for {{ $labels.group }}"
          description: "Consumer group {{ $labels.group }} has lag of {{ $value }} on topic {{ $labels.topic }}"

      - alert: DLQMessagesPresent
        expr: sum by (topic) (kafka_topic_partition_current_offset{topic=~".*\\.dlq"}) > 0
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "DLQ has messages on {{ $labels.topic }}"
          description: "Dead letter queue {{ $labels.topic }} has accumulated messages"

  - name: kinetix-services
    rules:
      - alert: ServiceDown
        expr: up == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "{{ $labels.job }} is down"
          description: "{{ $labels.job }} has been unreachable for more than 1 minute"

      - alert: HighErrorRate
        expr: sum by (job) (rate(ktor_http_server_requests_seconds_count{status=~"5.."}[5m])) / sum by (job) (rate(ktor_http_server_requests_seconds_count[5m])) > 0.05
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "High 5xx error rate on {{ $labels.job }}"
          description: "{{ $labels.job }} has a 5xx error rate of {{ $value | humanizePercentage }}"

      - alert: HighLatency
        expr: histogram_quantile(0.95, sum by (job, le) (rate(ktor_http_server_requests_seconds_bucket[5m]))) > 5
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High P95 latency on {{ $labels.job }}"
          description: "{{ $labels.job }} P95 latency is {{ $value }}s"

      - alert: JVMMemoryHigh
        expr: jvm_memory_used_bytes{area="heap"} / jvm_memory_max_bytes{area="heap"} > 0.9
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "JVM heap usage above 90% on {{ $labels.job }}"
          description: "{{ $labels.job }} heap usage is {{ $value | humanizePercentage }}"

  - name: kinetix-database
    rules:
      - alert: DBPoolExhausted
        expr: hikaricp_connections_pending > 5
        for: 2m
        labels:
          severity: critical
        annotations:
          summary: "DB connection pool exhausted on {{ $labels.pool }}"
          description: "{{ $labels.pool }} has {{ $value }} pending connection requests"

  - name: kinetix-grpc
    rules:
      - alert: GRPCHighLatency
        expr: histogram_quantile(0.95, rate(risk_var_calculation_duration_seconds_bucket[5m])) > 60
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Risk engine gRPC P95 latency exceeds 60s"
          description: "VaR calculation P95 duration is {{ $value }}s"
